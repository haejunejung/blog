import { AbortControllerDemo } from "../../demo"

# AbortController로 웹 요청 중단하기

## 0. 개요
최근에 백오피스에서 대량의 데이터를 CSV로 다운로드하는 기능이 필요해졌습니다. 다운로드를 중간에 취소하는 기능도 있었죠.
처음에는 다운로드를 취소하면 응답받은 데이터를 사용하지 않는 방식으로 구현했습니다.
이때, 사용자가 다운로드를 취소하더라도 서버에 계속 요청이 가는 것을 발견했습니다.
이 방법은 사용자가 다운로드를 취소하더라도 요청이 계속 진행되기 때문에 서버에 불필요한 부하를 주는 문제가 있었습니다.
이 문제를 해결하기 위해 AbortController를 사용하게 되었고, 이번 기회에 AbortController에 대해 정리해보려고 합니다.

## 1. AbortController란?
**AbortController은 하나 이상의 웹 요청을 중도에 중단할 수 있는 기능을 제공하는 웹 표준 API**입니다. 
기존에는 브라우저 레벨에서 fetch 요청을 취소하는 방법이 없었지만, AbortController를 사용하면 웹 요청을 프로그래밍적으로 제어할 수 있습니다.

간단한 HTTP 요청의 경우 응답받은 데이터가 필요없어지면, 데이터를 사용하지 않는 방식으로 해결해도 문제가 없지만
대량의 데이터를 요청하는 경우에는 서버에 불필요한 요청이 가는 문제가 발생합니다.
이런 경우에 AbortController를 사용하면 응답을 무시하는 것이 아니라 웹 요청 자체를 중단할 수 있습니다.

AbortController는 굉장히 심플한 인터페이스를 가지고 있습니다.
- abort(): AbortController의 abort 메서드를 호출하면, AbortController에 연결된 모든 요청이 중단됩니다.
- signal: AbortController의 signal 속성은 AbortSignal 객체를 반환합니다. 이 객체는 요청을 중단할 수 있는 신호를 전달하는 역할을 합니다.
    - reason: AbortSignal의 reason 속성은 요청을 중단한 이유를 나타냅니다. 기본값으로 AbortError를 가지고 있습니다.

```typescript
interface AbortController {
    /**
     * Returns the AbortSignal object associated with this object.
     */

    readonly signal: AbortSignal;
    /**
     * Invoking this method will set this object's AbortSignal's aborted flag and signal to any observers that the associated activity is to be aborted.
     */
    abort(reason?: any): void;
}
```

## 2. 왜 AbortController이 필요할까?
**단순하게 응답을 무시하는 것이 아니라 요청 자체의 중단이 필요한 이유**에 대해서 설명해보겠습니다.

예를 들어, CSV 다운로드를 위해서 서버에서 받아야 하는 데이터의 양이 총 50MB이고, 
사용자가 다운로드를 취소하는 시점에는 10MB까지만 받았다고 가정해보겠습니다.

### 2-1. AbortController 없이 요청을 취소하는 경우
| 상황 | 설명 |
| --- | --- |
| 요청 시작 후 10초 뒤 사용자가 다운로드를 취소함 | 다운로드를 취소하더라도 서버에 요청을 보내고 있음 |
| 서버가 50MB짜리 CSV 파일 전송 | 클라이언트는 50MB 전체를 다운로드 받음 |
| 결과 | 사용자는 데이터가 필요 없는데, 50MB 네트워크 사용량이 발생하고, 서버에는 불필요한 리소스를 소모함 |


### 2-2. AbortController로 다운로드 취소하는 경우
| 상황 | 설명 |
| --- | --- |
| 요청 시작 후 10초 뒤 사용자가 다운로드를 취소함 | 즉시 AbortController가 네트워크 요청을 중단함 |
| 서버가 중단된 시점까지만 데이터를 전송함 | 클라이언트는 10MB만 받고, 나머지는 다운로드 받지 않음 |
| 결과 | 사용자는 데이터가 필요 없고, 서버는 50MB가 아닌 10MB만 소모함 |

### 2-3. 데이터 절감 효과
| 상황 | AbortController ❌ | AbortController ✅ |
| --- | --- | --- |
| 1회 취소당 불필요한 다운로드 데이터 | 50MB | 10MB |
| 하루에 100회 요청시 | 5TB | 1TB |

이 예시에서는 AbortController를 사용하면 네트워크 데이터 사용량을 80% 절감할 수 있다는 것을 알 수 있습니다.
네트워크 데이터 사용량을 줄이는 것뿐만 아니라, 서버의 부하를 줄이고, 서버 리소스를 절약할 수 있습니다.
서버 비용도 그만큼 절감할 수 있을 것입니다.

## 3. AbortController 사용해보기
AbortController는 클래스로 구현되어 있으며 아래와 같이 생성할 수 있습니다.

```typescript
const abortController = new AbortController();
```

생성된 인스턴스에서 signal 속성을 abortable, promise-based API에 전달하여 요청을 중단할 수 있습니다.

```typescript
const abortController = new AbortController();
const { signal } = abortController;

async function fetchData() {
    const response = await fetch('https://example.com/api/data', { signal });
    const data = await response.json();
    console.log(data);
}

abortController.abort(); // 요청 중단
console.log(signal.aborted) // 요청이 중단되면 true로 변경된다.
```

아래 데모에서 실제로 AbortController를 사용하여 웹 요청을 중단하는 방법을 확인할 수 있습니다.
자세한 내용을 보고 싶다면 브라우저의 Network 탭을 확인해보세요.
<AbortControllerDemo />

## 4. 마치며
기존에는 단순히 웹 요청을 수행하고 응답을 무시하는 방식을 사용했습니다.
대용량의 데이터를 다루는 것과 같이 특수한 상황을 마주치지 않았기 때문에 고려하지 못했던 부분이었습니다.
하지만 대량의 데이터를 다루는 상황을 만나면서 단순히 응답을 무시하는 것이 아니라 요청 자체를 중단하는 것이 올바른 방법이라는 것을 알게 되었습니다.
이를 통해 단순히 네트워크 사용량을 줄이는 것뿐만 아니라 서버의 부하를 줄이고, 서버 리소스를 절약할 수 있다는 것을 알게 되었습니다.
앞으로는 웹 요청 자체를 중단해야 하는 상황에서는 AbortController를 사용해야겠다는 생각이 들었습니다.

fyi: toss/react-simplikit의 useAsyncEffect를 AbortController를 통해 개선할 수 있을 것 같다고 생각이 들었고,
[ISSUE](https://github.com/toss/react-simplikit/issues/220)를 등록해두었습니다. 

## References

- [MDN](https://developer.mozilla.org/en-US/docs/Web/API/AbortController)
- [whatwg](https://dom.spec.whatwg.org/#interface-AbortSignal)
- [Outsider's Dev Story](https://blog.outsider.ne.kr/1602?category=20)
- [logrocket](https://blog.logrocket.com/complete-guide-abortcontroller/)